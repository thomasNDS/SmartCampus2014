<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>AR - Flat UI</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">

        <!-- Loading Bootstrap -->
        <link href="bootstrapF2/css/bootstrap-responsive.css" rel="stylesheet" type="text/css">
        <link href="bootstrapF2/css/bootstrap.css" rel="stylesheet" type="text/css">
        <link href="bootstrapF2/css/prettify.css" rel="stylesheet">

        <!-- Loading Flat UI -->
        <link href="bootstrapF2/css/flat-ui.css" rel="stylesheet">

        <!-- Loading JSARToolkit -->
        <script src="js/libs/AR_mediaStream_fichiers/ga.js" async="" type="text/javascript"></script>
        <script src="js/libs/AR_mediaStream_fichiers/JSARToolKit.js"></script>
        <script src="js/libs/AR_mediaStream_fichiers/utils.js"></script>
        <script src="js/libs/jquery/jquery.min.js"></script>
        <!--<script src="bootstrapFlat/js/bootstrap.min.js"></script>-->

        <script>

            console.log("largeur" + window.innerWidth);

            //Fonction en cas d'erreur
            function onFailure(err) {
                alert("The following error occured: " + err.name);
            }

            //////////////////////////
            //GESTION LECTURE MARKER//
            //////////////////////////

            //Nombre de marqueurs possibles à lire??
            threshold = 128;
            //Var booleen pour savoir si on voit un qrCode
            qrVisible = false;
            currentMarker = null;

            $(window).ready(function() {

                ////////////////////////
                //// GESTION CAMERA ////
                ////////////////////////

                //Creation et configuration d'un element video, il sera utilise pour streamer la camera
                //L'element n'est pas affiche et est integre dans un canvas plus loin..
                var video = document.createElement('video');
//                video.width = 640;
//                video.height = 480;
                console.log("Avt fonction" + $(document).width());
                console.log("wrapper : " + window.innerWidth);

                video.width = window.innerWidth;
                video.height = window.innerHeight;
                video.loop = true;
                video.volume = 0;
                video.autoplay = true;
                video.style.display = 'none';
                video.controls = true;

                //getUser mutliplateforme
                navigator.getUserMedia = (navigator.getUserMedia ||
                        navigator.webkitGetUserMedia ||
                        navigator.mozGetUserMedia ||
                        navigator.msGetUserMedia);
                //Si getUser a marche, on le conf pour la video
                //En cas d'erreur, fonction de failure
                if (navigator.getUserMedia) {
                    navigator.getUserMedia({video: true},
                    function(localMediaStream) {
                        video.src = window.URL.createObjectURL(localMediaStream);
                    }, onFailure);
                }
                else {
                    alert('OOPS No browser Support');
                }

                console.log("Avt fonction" + $(document).width() + ", " + $("#wrapper").width());
                //Canvas pour la detection des marqueurs
                var canvas = document.createElement('canvas');
//                canvas.width = 320;
//                canvas.height = 240;
//                canvas.width = $(document).width();
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
//                canvas.style.display = 'block';

                //Canvas pour l'affichage de la video
                var videoCanvas = document.createElement('canvas');
                videoCanvas.setAttribute("id", "videoCanvas");
                console.log(video.width);
                videoCanvas.width = video.width;
                videoCanvas.height = video.height;
                // Create a RGB raster (image matricielle) object for the 2D canvas.
                // JSARToolKit uses raster objects to read image data.
                var raster = new NyARRgbRaster_Canvas2D(canvas);
                // FLARParam is the thing used by FLARToolKit to set camera parameters.
                var param = new FLARParam(canvas.width, canvas.height);
                // The FLARMultiIdMarkerDetector is the actual detection engine for marker detection.
                // It detects multiple ID markers. ID markers are special markers that encode a number.
                var detector = new FLARMultiIdMarkerDetector(param, 120);
                // For tracking video set continue mode to true. In continue mode, the detector
                // tracks markers across multiple frames.
                detector.setContinueMode(true);
                //Contexte du canvas, utilise plus tard pour afficher la video
                var ctx = canvas.getContext('2d');
                //Ajout du canvas de video a la page
                $("#backgroundVideo").append(videoCanvas);

                /// FULL SCREEN ///
                //// TODO ////
                function onResizeHandler(e) {
//                    var isFullScreen = document.mozFullScreen || document.webkitIsFullScreen || document.fullScreen;
//                    if (isFullScreen) {
                    video.width = window.innerWidth;
                    video.height = window.innerHeight;

                    videoCanvas.width = window.innerWidth;
                    videoCanvas.height = window.innerHeight;

                    console.log("larg " + window.innerWidth + "haut " + window.innerHeight);
                    videoCanvas.getContext('2d').drawImage(video, 0, 0, window.innerWidth, window.innerHeight);
//                    }
                }
                window.onresize = onResizeHandler;
//                window.onfullscreenchange = onResizeHandler;
//                window.onwebkitfullscreenchange = onResizeHandler;
//                window.onmozfullscreenchange = onResizeHandler;

                //////////////////////

                //Fonction appele a chaque interval
                setInterval(function() {

                    //Affichage image dans les deux canvas crees
                    videoCanvas.getContext('2d').drawImage(video, 0, 0, video.width, video.height);
//                    ctx.drawImage(videoCanvas, 0, 0, 320, 240);
                    ctx.drawImage(videoCanvas, 0, 0);
                    //Prevenir que le canvas a changer
                    canvas.changed = true;
                    //initiale avant d'entrer dans la boucle le qrvisible vu a faux
                    qrVisible = false;
                    //Creation du detecteur de marques, avec l'image matricielle et le nombre de marqueurs a detectes (surement..)
                    var detected = detector.detectMarkerLite(raster, threshold);
                    //id du marqueur lu
                    var currId;
                    // Go through the detected markers (and get their IDs and transformation matrices)
                    for (var idx = 0; idx < detected; idx++) {

                        //Si on entre dans cette boucle, c'est qu'on a lu un marqueur
                        qrVisible = true;
                        // Get the ID marker data for the current marker.
                        // ID markers are special kind of markers that encode a number.
                        // The bytes for the number are in the ID marker data.
                        var id = detector.getIdMarkerData(idx);
                        // This code handles only 32-bit numbers or shorter.
                        if (id.packetLength > 4) {
                            currId = -1;
                        } else {
                            currId = 0;
                            for (var i = 0; i < id.packetLength; i++) {
                                currId = (currId << 8) | id.getPacketData(i);
                            }
                        }
                        console.log("[add] : ID = " + currId);
                        //Test pour voir afficher l'id lu
                        $(".coucou").html(currId);
                    }

                    ////////////////////////
                    ///// INTERFACE AR /////
                    ////////////////////////

                    //Exemple de ce qu'on peut faire une fois un marqueur lu
                    //Si on a lu un marqueur on popup pour demander si on veut afficher info de l'element lu?
                    //TODO: possiblement plusieurs marqueurs lu..
                    if (qrVisible) {
//                        var afficherContenu = confirm("Code repéré, target destroyed ?");
//                        if (afficherContenu) {
//                            console.log("SWITCH" + currId);
//                            switch (currId) {
//                                case 0:
//                                    $("#contenu2").css('visibility', 'visible');
//                                    break;
//                                case 4 :
//                                    $("#contenu4").css('visibility', 'visible');
//                            }
//                        }

                        currentMarker = currId;
                        $("#popUpInfos").modal('show');
                    }
                }, 15);
            });

            /*
             * Fonction pour afficher le panneau d'information du batiment que l'on a repéré
             */
            function showInfoPanel() {
                console.log("showPanel");
                switch (currentMarker) {
                    case 0:
                        $("#contenu2").css('visibility', 'visible');
                        $("#contenu4").css('visibility', 'hidden');
                        break;
                    case 4 :
                        $("#contenu2").css('visibility', 'hidden');
                        $("#contenu4").css('visibility', 'visible');
                        break;
                    default :
                        console.log("Pas reconnu");
                }
            }

            // Find the right method, call on correct element
            function launchFullscreen(element) {
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
            }

            function exitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }

            function manageFullScreen(elementToFullScreened) {
                var isFullScreen = document.mozFullScreen || document.webkitIsFullScreen || document.fullScreen;
                if (isFullScreen) {
                    $("#btnFullScreen").html("FullScreen");
                    exitFullscreen();
                } else {
                    launchFullscreen(elementToFullScreened);
                    $("#btnFullScreen").html("Normal");
                }
            }

        </script>

        <style>
            html {
                background: black;
                color: white;
            }
            body {
                margin: 0;
                padding: 0;
            }
            .coucou {
                text-decoration-color: black;
            }
            #contenu2 {
                background-color: yellow;
                /*width : 400px;*/
                height: 100px;
                /*                                position: absolute;
                                                left: 100px;
                                                top: 150px;*/
            }
            #contenu4 {
                background-color: blue;
                /*width : 400px;*/
                height: 100px;
                /*                position: absolute;
                                left: 100px;
                                top: 250px;*/
            }
            #navBar{
                margin-bottom: 0px;
            }
            #backgroundVideo{
                position: absolute;
                /*top : 0px;*/
            }
            #mainContent {
                position : relative;
            }
            #pageContent{
                /*position : absolute;*/
                /*top : 100px;*/
                /*background-color: green;*/
                border-style: solid;
                border-width: 1px;
            }
            #wrapper{
                max-width: 100%;
                width: 100%;
            }
            #popUpFooter {
                text-align: center;
            }
            #popUpInfos {
                width: 60%;
                position: absolute;
                top: 20%;
                left: 20%;
                margin-top: 0%;
                margin-left: 0%;
            }

            //Ajout pour un offset vertical
            .voffset  { margin-top: 2px; }
            .voffset1 { margin-top: 5px; }
            .voffset2 { margin-top: 10px; }
            .voffset3 { margin-top: 15px; }
            .voffset4 { margin-top: 30px; }
            .voffset5 { margin-top: 40px; }
            .voffset6 { margin-top: 60px; }
            .voffset7 { margin-top: 80px; }
            .voffset8 { margin-top: 100px; }
            .voffset9 { margin-top: 150px; }
        </style>

    </head>
    <body>
        <div id="wrapper">

            <!--MENU-->
            <nav id="navBar" class="navbar navbar-default navbar-inverse" role="navigation">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-01">
                        <span class="sr-only">Toggle navigation</span>
                    </button>
                    <a class="navbar-brand" href="#">SmartCampus</a>
                </div>
                <div class="collapse navbar-collapse" id="navbar-collapse-01">
                    <ul class="nav navbar-nav">           
                        <!--<li class="active"><a href="#fakelink">Paramètres</a></li>-->
                        <li><a href="#fakelink">Paramètres</a></li>
                        <li><a href="#fakelink">Aide</a></li>
                    </ul>           
                    <button id="btnFullScreen" class="btn btn-default navbar-btn navbar-right" onclick="manageFullScreen(document.documentElement);">FullScreen</button>
                    <button class="btn btn-default navbar-btn navbar-right" type="button">Switch</button>
                </div>
            </nav>

            <!--DIV POUR LA VIDEO-->
            <div id="backgroundVideo"></div>

            <!--DIV QUI CONTIENDRA L'UI-->
            <div id="mainContent" class="container-fluid">
                <div class="row-fluid voffset7">
                    <!--<div id="pageContent" class="span12">-->
                    <div id="pageContent" class="col-md-12">
                        <div class="row-fluid">
                            <!--<div id="contenu2" class="span3 offset6">-->
                            <div id="contenu2" class="col-md-3 col-md-offset-6">
                                <div class="coucou"></div>
                            </div>
                        </div>
                        <div class="row-fluid">
                            <!--<div id="contenu4" class="span11">-->
                            <div id="contenu4" class="col-md-11">
                                <div class="coucou"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- POP UP AFFICHER QUAND EN FACE D'UN BATIMENT -->
                <div id="popUpInfos" class="modal hide fade">
                    <div class="modal-header"> <a class="close" data-dismiss="modal">×</a>
                        <h3>Informations bâtiments détectées</h3>
                    </div>
                    <div class="modal-body">
                        Voulez-vous l'afficher ?
                    </div>
                    <div id="popUpFooter" class="modal-footer"> 
                        <a class="btn btn-success" onclick="showInfoPanel()" data-dismiss="modal">Afficher</a>
                        <a class="btn btn-inverse" data-dismiss="modal">Annuler</a> 
                    </div>
                </div>
                <!--<a class="btn btn-primary" data-toggle="modal" data-target="#infos">Plus d'informations</a>-->
            </div>
        </div>


        <!-- Load JS here for greater good =============================-->
        <!--<script src="js/jquery-1.8.3.min.js"></script>-->
        <script src="js/jquery-ui-1.10.3.custom.min.js"></script>
        <script src="js/jquery.ui.touch-punch.min.js"></script>
        <script src="js/jquery.tagsinput.js"></script>
        <script src="js/jquery.placeholder.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/bootstrap-select.js"></script>
        <script src="js/bootstrap-switch.js"></script>
        <script src="js/flatui-checkbox.js"></script>
        <script src="js/flatui-radio.js"></script>
        <script src="js/typeahead.js"></script>
        <script src="js/application.js"></script>
    </body>
</html>
