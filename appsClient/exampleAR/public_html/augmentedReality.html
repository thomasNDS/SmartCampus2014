<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>AR - Bootstrap</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">

        <!-- Loading Bootstrap -->
        <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet" type="text/css">
        <link href="bootstrap/css/bootstrap.css" rel="stylesheet" type="text/css">


        <!-- CSS de la page -->
        <link href="css/style.css" rel="stylesheet" type="text/css">

        <!-- JS -->
        <script src="js/libs/AR_mediaStream_fichiers/ga.js" async="" type="text/javascript"></script>
        <script src="js/libs/AR_mediaStream_fichiers/JSARToolKit.js"></script>
        <script src="js/libs/AR_mediaStream_fichiers/utils.js"></script>
        <script src="js/libs/jquery/jquery.min.js"></script>
        <script src="js/screenManagement.js"></script>
        <script src="bootstrap/js/bootstrap.min.js"></script>

        <script>

            //Fonction en cas d'erreur
            function onFailure(err) {
                alert("The following error occured: " + err.name);
            }

            //////////////////////////
            //GESTION LECTURE MARKER//
            //////////////////////////

            //Nombre de marqueurs possibles à lire??
            threshold = 128;
            //Var booleen pour savoir si on voit un qrCode
            qrVisible = false;
            //Marqueur courant
            currentMarker = null;
            //Marqueur du panel courant
            currentPanelMarker = null;
            //APPLI//

            //Var booleen pour savoir si un panel est affiché ou non
            isPanelDisplayed = false;
            //Tableau contenant les différents éléments 
            entitiesArray = new Array();
            //Adresse du serveur web
//            serverAddress = "192.168.1.2";
            serverAddress = "localhost";
            $(window).ready(function() {

                scrollBarWidth = 0; //getScrollerWidth();
                menuHeight = $("#menu").height() + 5;
//                console.log("sc : " + scrollBarWidth);
//                console.log("menu height : " + $("#menu").height());

                ////////////////////////
                //// GESTION CAMERA ////
                ////////////////////////

                //Creation et configuration d'un element video, il sera utilise pour streamer la camera
                //L'element n'est pas affiche et est integre dans un canvas plus loin..
                var video = document.createElement('video');
//                video.width = 640;
//                video.height = 480;
//                console.log("Avt fonction" + $(document).width());
                video.width = $(document).width() - scrollBarWidth;
                video.height = $(document).height() - menuHeight;
                video.loop = true;
                video.volume = 0;
                video.autoplay = true;
                video.style.display = 'none';
                video.controls = true;
                //getUser mutliplateforme
                navigator.getUserMedia = (navigator.getUserMedia ||
                        navigator.webkitGetUserMedia ||
                        navigator.mozGetUserMedia ||
                        navigator.msGetUserMedia);
                //Si getUser a marche, on le conf pour la video
                //En cas d'erreur, fonction de failure
                if (navigator.getUserMedia) {
                    navigator.getUserMedia({video: true},
                    function(localMediaStream) {
                        video.src = window.URL.createObjectURL(localMediaStream);
                    }, onFailure);
                }
                else {
                    alert('No browser Support');
                }

                //Canvas pour la detection des marqueurs
                var canvas = document.createElement('canvas');
                canvas.width = $(document).width(); // - scrollBarWidth;
                canvas.height = $(document).height(); // - menuHeight;

                //Canvas pour l'affichage de la video
                var videoCanvas = document.createElement('canvas');
                videoCanvas.setAttribute("id", "videoCanvas");
                videoCanvas.width = video.width - scrollBarWidth;
                videoCanvas.height = video.height - menuHeight;
                // Create a RGB raster (image matricielle) object for the 2D canvas.
                // JSARToolKit uses raster objects to read image data.
                var raster = new NyARRgbRaster_Canvas2D(canvas);
                // FLARParam is the thing used by FLARToolKit to set camera parameters.
                var param = new FLARParam(canvas.width, canvas.height);
                // The FLARMultiIdMarkerDetector is the actual detection engine for marker detection.
                // It detects multiple ID markers. ID markers are special markers that encode a number.
                var detector = new FLARMultiIdMarkerDetector(param, 120);
                // For tracking video set continue mode to true. In continue mode, the detector
                // tracks markers across multiple frames.
                detector.setContinueMode(true);
                //Contexte du canvas, utilise plus tard pour afficher la video
                var ctx = canvas.getContext('2d');
                //Ajout du canvas de video a la page
//                document.body.appendChild(videoCanvas);
                $("#backgroundVideo").append(videoCanvas);
                //Fonction appele a chaque interval
                setInterval(function() {

                    //Affichage image dans les deux canvas crees
                    //Affichage pour la video
                    videoCanvas.getContext('2d').drawImage(video, 0, 0, video.width, video.height);
//                    ctx.drawImage(videoCanvas, 0, 0, 320, 240);
                    //Prise de l'image du canvas pour la detection marker
                    ctx.drawImage(videoCanvas, 0, 0);
                    //Prevenir que le canvas a changer
                    canvas.changed = true;
                    //initialise avant d'entrer dans la boucle le qrvisible vu a faux
                    qrVisible = false;
                    //Creation du detecteur de marques, avec l'image matricielle et le nombre de marqueurs a detectes (surement..)
                    var detected = detector.detectMarkerLite(raster, threshold);
                    //id du marqueur lu
                    var currId;
                    // Go through the detected markers (and get their IDs and transformation matrices)
                    for (var idx = 0; idx < detected; idx++) {

                        //Si on entre dans cette boucle, c'est qu'on a lu un marqueur
                        qrVisible = true;
                        // Get the ID marker data for the current marker.
                        // ID markers are special kind of markers that encode a number.
                        // The bytes for the number are in the ID marker data.
                        var id = detector.getIdMarkerData(idx);
                        // This code handles only 32-bit numbers or shorter.
                        if (id.packetLength > 4) {
                            currId = -1;
                        } else {
                            currId = 0;
                            for (var i = 0; i < id.packetLength; i++) {
                                currId = (currId << 8) | id.getPacketData(i);
                            }
                        }
//                        console.log("[add] : ID = " + currId);
                    }

                    ////////////////////////
                    ///// INTERFACE AR /////
                    ////////////////////////

                    var isPopUpShown = $('#popUpInfos').hasClass('in');
                    var isBottomPopUpShown = $('#bottomPopUp').css("display") === 'block';
                    //Exemple de ce qu'on peut faire une fois un marqueur lu
                    //Si on a lu un marqueur on popup pour demander si on veut afficher info de l'element lu?
                    //TODO: possiblement plusieurs marqueurs lu..
                    if (qrVisible && !isPopUpShown && !isBottomPopUpShown) {
                        //Si le marker que l'on lit est différent de celui affiché on affiche le popup pour changer de panel
//                        if (getPanelFromMarker(currId) !== getPanelFromMarker(currentPanelMarker)) {
                        if (currId !== currentPanelMarker) {
                            showPopUp(currId);
                            currentMarker = currId;
                        }
                    }
                }, 15);
                /// FULL SCREEN ///
                //// TODO : Probleme avec le canvas de detection + paysage / portrait resize foireux ////
                function onResizeHandler(e) {
//                    console.log("full");
//                    var isFullScreen = document.mozFullScreen || document.webkitIsFullScreen || document.fullScreen;
//                    if (isFullScreen) {
                    menuHeight = $("#menu").height() + 5;
//                    console.log("menu height : " + $("#menu").height());

                    video.width = window.innerWidth - scrollBarWidth;
                    video.height = window.innerHeight - menuHeight;
                    videoCanvas.width = window.innerWidth - scrollBarWidth;
                    videoCanvas.height = window.innerHeight - menuHeight;
                    changeMaxHeightContentTabs();
//                    canvas.width = $(document).width();// - scrollBarWidth;
//                    canvas.height = $(document).height();

//                    console.log("larg " + window.innerWidth + "haut " + window.innerHeight);
//                    videoCanvas.getContext('2d').drawImage(video, 0, 0, window.innerWidth - scrollBarWidth, window.innerHeight - menuHeight);
//                    videoCanvas.getContext('2d').drawImage(video, 0, 0, video.width, video.height);
//                    }
                }
                window.onresize = onResizeHandler;
//                window.onfullscreenchange = onResizeHandler;
//                window.onwebkitfullscreenchange = onResizeHandler;
//                window.onmozfullscreenchange = onResizeHandler;

                //////////////////////

                function changeMaxHeightContentTabs() {
                    var height = parseInt($("#backgroundVideo").css("height"));
                    console.log("h " + height);
                    var maxHeightContentTab = height * (65 / 100);
                    console.log("max: " + maxHeightContentTab);
                    $("#contentTabs").css("max-height", maxHeightContentTab);
                }

            });
            /*
             * Fonction pour afficher le panneau d'information du batiment que l'on a repéré
             */
            function showInfoPanel() {
                //On enregistre le marqueur
                currentPanelMarker = currentMarker;
                //Si le panel du bas est affiché
                if ($("#bottomPopUp").css('display') === 'block') {
                    //On ferme le popUp du bas
                    closeBottomPopUp();
                }

                //On cherche l'element actuellement detecte dans le tableau via un id
                var elemDetected = entitiesArray[currentPanelMarker];
                //Construction du panel d'info en fonction de l'element
                buildPanel(elemDetected);
                $("#informationPanel").css("display", "block");
                isPanelDisplayed = true;
            }

            /*
             * Ouverture du pop en fonction du batiment detecté
             * @returns {undefined}
             */
            function showPopUp(curMarker) {
                var elem = entitiesArray[curMarker];
                var textTitle = elem.name;
                var textBody = elem.description;
                var textType = elem.type;
                $("#popUpTitle").html(textTitle);
                $("#popUpContent").html(textType + ", voulez-vous l'afficher ?");
//                $("#popUpContent").html(textBody);
                $("#bottomPopUpDescription").html("<strong>" + textTitle + "</strong> - " + textType);
                //Si le panel centrale n'est pas affiché, popup centrale
                //Sinon popUp bottom
                if (!isPanelDisplayed) {
                    $("#popUpInfos").modal('show');
                } else {
                    showBottomPopUp();
                }

            }


            /*
             * Ferme le panel actuellement ouvert
             */
            function closePanel() {
                currentPanelMarker = null;
                $("#informationPanel").css("display", "none");
                isPanelDisplayed = false;
            }

            function switchAction() {
                window.location = 'index.html';
            }

            function paramaterAction() {
//                currentMarker = 5;
//                showPopUp(currentMarker);
                getVoteValue();
            }

            function helpAction() {
//                currentMarker = 3;
//                showPopUp(currentMarker);
                voteTest();
            }

            /*
             * Afficher le popup du bas
             */
            function showBottomPopUp() {
                $("#bottomPopUp").animate({
                    height: "toggle"
                }, 600, "linear", function() {
//                    console.log("show!!");
                });
            }

            /*
             * Fermer le popup du bas
             */
            function closeBottomPopUp() {
                $("#bottomPopUp").animate({
                    height: "toggle"
                }, 500, "linear", function() {
//                    console.log("close!!");
                });
            }


            /*
             * Fonction pour charger le tableau des elements
             */
            function loadEntities() {
                var entities;
                //Requete pour get toutes les entités de la BD
                jQuery.ajax({
                    type: 'GET',
                    async: false,
                    url: "http://" + serverAddress + ":4242/api/entity",
//                    url: 'http://localhost:4242/api/entity',
                    success: function(data) {
                        console.dir(data);
                        entities = data;
                    }
                });
                //On les stocke dans un tableau
                for (var i = 0; i < entities.payload.length; i++) {
                    entitiesArray[i] = entities.payload[i];
                }

            }

            /*
             * Charger les items d'une entite
             * @param {type} entity
             * @returns {loadItemsOfEntity.items}
             */
            function loadItemsOfEntity(entity) {
                var items;
                entity.items.forEach(function(item) {
                    items.push(loadItemById(item.id));
                });
                return items;
            }

            /*
             * Charge les elements d'un item (Requete)
             * @param {type} objElem
             * @returns {undefined}
             */
            function loadItemById(id) {
                var item;
                jQuery.ajax({
                    type: 'GET',
                    async: false,
                    url: "http://" + serverAddress + ":4242/api/item/" + id,
//                    url: 'http://localhost:4242/api/item/' + id,
                    success: function(data) {
                        console.dir(data.payload[0]);
                        item = data.payload[0];
                    }
                });
                return item;
            }

            /*
             * Charge un commentaire à partir de son id
             * @param {type} id
             * @returns {unresolved}
             */
            function loadComById(id) {
                var com;
                jQuery.ajax({
                    type: 'GET',
                    async: false,
                    url: "http://" + serverAddress + ":4242/api/comment/" + id,
//                    url: 'http://localhost:4242/api/comment/' + id,
                    success: function(data) {
                        console.dir(data.payload[0]);
                        com = data.payload[0];
                    },
                    error: function(err) {
                        console.log(err);
                    }
                });
                return com;
            }

            /*
             * Ajout d'un commentaire 'comment' à un entite d'id 'entityId'
             * @param {type} objElem
             * @returns {undefined}
             */
            function addComment(entityId, comment) {
                console.log(entityId, comment);
                var com;
                jQuery.ajax({
                    type: 'POST',
                    async: false,
                    data: {
                        entityId: entityId,
                        commentValue: comment
                    },
                    url: "http://" + serverAddress + ":4242/add_comment",
//                    url: 'http://localhost:4242/add_comment',
                    success: function(data) {
                        console.log("Comment created" + data);
                    },
                    error: function(err) {
                        console.log("Loupé :P");
                        console.log(err);
                    }
                });
                refreshEntity(entityId);
                return com;
            }

            function voteTest() {
                
                //recupere le vote choisis
                var vote = $('input[name="vote"]:checked').val();
//                var vote = 5;
                
                console.log("vote = " + vote);
                jQuery.ajax({
                    type: 'POST',
                    async: false,
                    data: {
                        value: vote
                    },
                    url: "http://" + serverAddress + ":4242/vote/vote_ru2",
//                    url: 'http://localhost:4242/add_comment',
                    success: function(data) {
                        console.log("vote effectué\n" + data);
                    },
                    error: function(err) {
                        console.log(er);
                    }
                });
                
                //Met a jour la moyenne
                $("#avgVote").html(getVoteValue());
            }

            function getVoteValue() {
                var vote = 0;
                jQuery.ajax({
                    type: 'GET',
                    async: false,
                    url: "http://" + serverAddress + ":4242/vote/moyenne_ru",
//                    url: 'http://localhost:4242/add_comment',
                    success: function(data) {
                        console.log("resultat = " + data);
                        vote = data;
                    },
                    error: function(err) {
                        console.log(err);
                    }
                });
                return vote;
            }

            /*
             * Fonction pour mettre à jour une entité d'id "entityId"
             * @param {type} objElem
             * @returns {undefined}
             */
            function refreshEntity(entityId) {
                var i = 0;
                var isFound = false;
                var indexEntity;
                //Recupere l'index de l'entite dans le tableau
                while (i < entitiesArray.length && !isFound) {
                    if (entitiesArray[i]._id === entityId) {
                        isFound = true;
                        indexEntity = i;
                    }
                    i++;
                }
                //Mise a jour de l'entite dans le tableau
                jQuery.ajax({
                    type: 'GET',
                    async: false,
                    url: "http://" + serverAddress + ":4242/api/entity/" + entityId,
//                    url: 'http://localhost:4242/api/entity/' + entityId,
                    success: function(data) {
                        console.dir(data);
                        entitiesArray[indexEntity] = data.payload[0];
                    }
                });
                //Rebuild du panel pour mettre à jour l'item commentaire
                //@TODO : Optimiser (rechargement d'un seul item)
                buildPanel(entitiesArray[indexEntity]);
            }

            function checkDescriptionHeight() {
                console.log($("#entityDescription").css("height"));
            }

            function activeBtn(){
                $("#btnVote").attr("disabled", false);
            }

            function buildVotePanel() {
                var avg = getVoteValue();
                console.log(avg);
                var txtActualAvg = "Estimation queue";
                var html = "<div id=\"votePanel\">";
                html += "<div>" + txtActualAvg + " : <span id=\"avgVote\">" + avg + "</span></div>";
                html += "<input type = \"radio\" name = \"vote\" value = \"1\" onclick=\"activeBtn()\")\"> Non  ";
                html += "<input type = \"radio\" name = \"vote\" value = \"2\" onclick=\"activeBtn()\"> Un peu  ";
                html += "<input type = \"radio\" name = \"vote\" value = \"3\" onclick=\"activeBtn()\"> Ca va  ";
                html += "<input type = \"radio\" name = \"vote\" value = \"4\" onclick=\"activeBtn()\"> Pas mal  ";
                html += "<input type = \"radio\" name = \"vote\" value = \"5\" onclick=\"activeBtn()\"> Abusé gros!<br/>";
                html += "<button id=\"btnVote\" type=\"button\" class=\"btn btn-primary\" onclick=\"voteTest()\" disabled>Alerte les autres :)</button>";
                html += "</div>";
                
                return html;
            }

            /*
             * Chargement d'un objet représentant l'element detecté
             * Information des différents labels du panel :
             *      .Titre
             *      .Onglets
             *          .Titre onglet
             *          .Contenu
             */
            function buildPanel(objElem) {

                /* Clean le panel */
                cleanChildOfNodeID("tabsPanel");
                cleanChildOfNodeID("contentTabs");
                //Titre du panel info
                $("#informationTitle").html(objElem.name);
                //Onglet Description
                var tabTitle = "";
                var tabContent = "";
                tabTitle = "<li class=\"active\"><a href=\"#entityDescription\" data-toggle=\"tab\">Description</a></li>";
                tabContent = "<div id=\"entityDescription\" class=\"tab-pane active\" id=\"tabbedPanDesc\">";
                tabContent += objElem.description;
                console.log("nb cara :" + objElem.description.length);
                
                tabContent += buildVotePanel();
                
                //Div pour bouton addComment
                tabContent += "<div class=\"moreBtn\"><button class=\"btn btn-primary\">Plus d'infos</button></div>";
                tabContent += "</div>";
                $("#tabsPanel").append(tabTitle);
                $("#contentTabs").append(tabContent);
                checkDescriptionHeight();
                //Onglets Items
                objElem.items.forEach(function(itemId, index) {

                    var itemLoaded = loadItemById(itemId);
                    tabTitle = "<li><a href=\"#tabbedPan" + index + "\" data-toggle=\"tab\">" + itemLoaded.name + "</a></li>";
                    $("#tabsPanel").append(tabTitle);
                    tabContent = "<div class=\"tab-pane\" id=\"tabbedPan" + index + "\">" + itemLoaded.description + "</div>";
                    $("#contentTabs").append(tabContent);
                });
                //Onglet Com
                var coms = objElem.comments;
                tabTitle = "<li><a href=\"#tabbedPan" + (objElem.items.length) + "\" data-toggle=\"tab\">Avis</a></li>";
                $("#tabsPanel").append(tabTitle);
                tabContent = "<div class=\"tab-pane\" id=\"tabbedPan" + (objElem.items.length) + "\">";
                objElem.comments.forEach(function(comId) {
                    var com = loadComById(comId);
                    var date = new Date(com.date);
                    tabContent += "<div>" + date.toLocaleDateString() + " : " + com.value + "</div>";
                });
                //Div pour bouton addComment
//                console.log("id" + objElem._id + "!!!!");
                tabContent += "<div class=\"commentBtn\"><button class=\"btn btn-primary\" onclick=\"addComment('" + objElem._id + "','aaa'" + ")\">Ajouter un commentaire</button></div>";
                tabContent += "</div>";
                $("#contentTabs").append(tabContent);
            }

            /*
             * Enleve les child d'un node
             */
            function cleanChildOfNodeID(parentNode) {
                var myNode = document.getElementById(parentNode);
                while (myNode.firstChild) {
                    myNode.removeChild(myNode.firstChild);
                }
            }

        </script>

    </head>
    <body>
        <div id="wrapper">
            <!--MENU-->
            <nav id="menu" class="navbar navbar-static-top navbar-inverse">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <ul class="nav">
                            <li><a href="#" onclick="paramaterAction();"><i class="icon-white icon-cog"></i> Paramètres</a></li>
                            <li><a href="#" onclick="helpAction();"><i class="icon-white icon-info-sign"></i> Aide</a></li>
                        </ul>
                        <button id="btnFullScreen" class="btn btn-primary pull-right" onclick="manageFullScreen(document.documentElement);"><i class="icon-white icon-fullscreen"></i> FullScreen</button>
                        <button class="btn btn-primary pull-right" onclick="switchAction()"><i class="icon-white icon-map-marker"></i> Carte</button>
                    </div>
                </div>
            </nav>

            <!--DIV POUR LA VIDEO-->
            <div id="backgroundVideo"></div>

            <!--DIV QUI CONTIENDRA L'UI-->
            <div id="mainContent" class="container-fluid">
                <!-- Tout le contenu dans une row -->
                <div class="row-fluid voffset5">
                    <div id="pageContent" class="span12">

                        <div id="informationPanel">
                            <div class="titlePanel">
                                <h3 id="informationTitle"></h3>
                                <button class="btn btn-primary" onclick="closePanel()">x</button>
                            </div>
                            <div class="tabbable tabs-left">
                                <ul id="tabsPanel" class="nav nav-tabs">
                                </ul>
                                <div id="contentTabs" class="tab-content"></div>
                            </div>
                        </div>

                    </div>

                    <!-- POP UP AFFICHER QUAND EN FACE D'UN BATIMENT -->
                    <div id="popUpInfos" class="modal hide fade">
                        <div class="modal-header"> <a class="close" data-dismiss="modal">×</a>
                            <h3 id="popUpTitle"></h3>
                        </div>
                        <div id="popUpContent" class="modal-body">
                            Voulez-vous l'afficher ?
                        </div>
                        <div id="popUpFooter" class="modal-footer"> 
                            <a class="btn btn-success" onclick="showInfoPanel()" data-dismiss="modal">Plus d'informations ?</a>
                        </div>
                    </div>

                    <!-- Barre du bas pour le popUp info quand un panel est déjà affiché-->
                    <nav id="bottomPopUp" class="navbar navbar-fixed-bottom navbar-inverse">
                        <div class="navbar-inner">
                            <div class="container-fluid" >
                                <button class="btn btn-large btn-primary pull-right" onclick="closeBottomPopUp()">X</button>
                                <div id="bottomPopUpArrow" class="row-fluid" onclick="showInfoPanel()">^</div>
                                <div id="bottomPopUpContent" class="row-fluid" onclick="showInfoPanel()">
                                    <div id="bottomPopUpPicture" class="span2"></div>
                                    <div id="bottomPopUpDescription" class="span7"></div>
                                </div>
                            </div>
                        </div>
                    </nav>

                </div>
            </div>
        </div>

        <script>
            loadEntities();
        </script>
    </body>
</html>
