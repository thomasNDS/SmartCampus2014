<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>AR - Bootstrap</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">

        <!-- Loading Bootstrap -->
        <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet" type="text/css">
        <link href="bootstrap/css/bootstrap.css" rel="stylesheet" type="text/css">


        <!-- CSS de la page -->
        <link href="css/style.css" rel="stylesheet" type="text/css">

        <!-- JS -->
        <script src="js/libs/AR_mediaStream_fichiers/ga.js" async="" type="text/javascript"></script>
        <script src="js/libs/AR_mediaStream_fichiers/JSARToolKit.js"></script>
        <script src="js/libs/AR_mediaStream_fichiers/utils.js"></script>
        <script src="js/libs/jquery/jquery.min.js"></script>
        <script src="js/screenManagement.js"></script>
        <script src="bootstrap/js/bootstrap.min.js"></script>

        <script>

            //Fonction en cas d'erreur
            function onFailure(err) {
                alert("The following error occured: " + err.name);
            }

            //////////////////////////
            //GESTION LECTURE MARKER//
            //////////////////////////

            //Nombre de marqueurs possibles à lire??
            threshold = 128;
            //Var booleen pour savoir si on voit un qrCode
            qrVisible = false;
            //Marqueur courant
            currentMarker = null;
            //Marqueur du panel courant
            currentPanelMarker = null;
            //Var booleen pour savoir si un panel est affiché ou non
            isPanelDisplayed = false;

            //Tableau contenant les différents éléments 
            elementsArray = new Array();

            $(window).ready(function() {

                scrollBarWidth = 0;//getScrollerWidth();
                menuHeight = $("#menu").height() + 5;
                console.log("sc : " + scrollBarWidth);
                console.log("menu height : " + $("#menu").height());

                ////////////////////////
                //// GESTION CAMERA ////
                ////////////////////////

                //Creation et configuration d'un element video, il sera utilise pour streamer la camera
                //L'element n'est pas affiche et est integre dans un canvas plus loin..
                var video = document.createElement('video');
//                video.width = 640;
//                video.height = 480;
//                console.log("Avt fonction" + $(document).width());
                video.width = $(document).width() - scrollBarWidth;
                video.height = $(document).height() - menuHeight;
                video.loop = true;
                video.volume = 0;
                video.autoplay = true;
                video.style.display = 'none';
                video.controls = true;

                //getUser mutliplateforme
                navigator.getUserMedia = (navigator.getUserMedia ||
                        navigator.webkitGetUserMedia ||
                        navigator.mozGetUserMedia ||
                        navigator.msGetUserMedia);
                //Si getUser a marche, on le conf pour la video
                //En cas d'erreur, fonction de failure
                if (navigator.getUserMedia) {
                    navigator.getUserMedia({video: true},
                    function(localMediaStream) {
                        video.src = window.URL.createObjectURL(localMediaStream);
                    }, onFailure);
                }
                else {
                    alert('No browser Support');
                }

                //Canvas pour la detection des marqueurs
                var canvas = document.createElement('canvas');
//                canvas.width = 320;
//                canvas.height = 240;
                canvas.width = $(document).width();// - scrollBarWidth;
                canvas.height = $(document).height();// - menuHeight;
//                canvas.style.display = 'block';

                //Canvas pour l'affichage de la video
                var videoCanvas = document.createElement('canvas');
                videoCanvas.setAttribute("id", "videoCanvas");
                videoCanvas.width = video.width - scrollBarWidth;
                videoCanvas.height = video.height - menuHeight;
                // Create a RGB raster (image matricielle) object for the 2D canvas.
                // JSARToolKit uses raster objects to read image data.
                var raster = new NyARRgbRaster_Canvas2D(canvas);
                // FLARParam is the thing used by FLARToolKit to set camera parameters.
                var param = new FLARParam(canvas.width, canvas.height);
                // The FLARMultiIdMarkerDetector is the actual detection engine for marker detection.
                // It detects multiple ID markers. ID markers are special markers that encode a number.
                var detector = new FLARMultiIdMarkerDetector(param, 120);
                // For tracking video set continue mode to true. In continue mode, the detector
                // tracks markers across multiple frames.
                detector.setContinueMode(true);
                //Contexte du canvas, utilise plus tard pour afficher la video
                var ctx = canvas.getContext('2d');
                //Ajout du canvas de video a la page
//                document.body.appendChild(videoCanvas);
                $("#backgroundVideo").append(videoCanvas);

                //Fonction appele a chaque interval
                setInterval(function() {

                    //Affichage image dans les deux canvas crees
                    //Affichage pour la video
                    videoCanvas.getContext('2d').drawImage(video, 0, 0, video.width, video.height);
//                    ctx.drawImage(videoCanvas, 0, 0, 320, 240);
                    //Prise de l'image du canvas pour la detection marker
                    ctx.drawImage(videoCanvas, 0, 0);
                    //Prevenir que le canvas a changer
                    canvas.changed = true;
                    //initialise avant d'entrer dans la boucle le qrvisible vu a faux
                    qrVisible = false;
                    //Creation du detecteur de marques, avec l'image matricielle et le nombre de marqueurs a detectes (surement..)
                    var detected = detector.detectMarkerLite(raster, threshold);
                    //id du marqueur lu
                    var currId;
                    // Go through the detected markers (and get their IDs and transformation matrices)
                    for (var idx = 0; idx < detected; idx++) {

                        //Si on entre dans cette boucle, c'est qu'on a lu un marqueur
                        qrVisible = true;
                        // Get the ID marker data for the current marker.
                        // ID markers are special kind of markers that encode a number.
                        // The bytes for the number are in the ID marker data.
                        var id = detector.getIdMarkerData(idx);
                        // This code handles only 32-bit numbers or shorter.
                        if (id.packetLength > 4) {
                            currId = -1;
                        } else {
                            currId = 0;
                            for (var i = 0; i < id.packetLength; i++) {
                                currId = (currId << 8) | id.getPacketData(i);
                            }
                        }
//                        console.log("[add] : ID = " + currId);
                    }

                    ////////////////////////
                    ///// INTERFACE AR /////
                    ////////////////////////

                    var isPopUpShown = $('#popUpInfos').hasClass('in');
                    var isBottomPopUpShown = $('#bottomPopUp').css("display") === 'block';

                    //Exemple de ce qu'on peut faire une fois un marqueur lu
                    //Si on a lu un marqueur on popup pour demander si on veut afficher info de l'element lu?
                    //TODO: possiblement plusieurs marqueurs lu..
                    if (qrVisible && !isPopUpShown && !isBottomPopUpShown) {
                        //Si le marker que l'on lit est différent de celui affiché on affiche le popup pour changer de panel
//                        if (getPanelFromMarker(currId) !== getPanelFromMarker(currentPanelMarker)) {
                        if (currId !== currentPanelMarker) {
                            showPopUp(currId);
                            currentMarker = currId;
                        }
                    }
                }, 15);


                /// FULL SCREEN ///
                //// TODO : Probleme avec le canvas de detection + paysage / portrait resize foireux ////
                function onResizeHandler(e) {
//                    console.log("full");
//                    var isFullScreen = document.mozFullScreen || document.webkitIsFullScreen || document.fullScreen;
//                    if (isFullScreen) {
                    menuHeight = $("#menu").height() + 5;
//                    console.log("menu height : " + $("#menu").height());

                    video.width = window.innerWidth - scrollBarWidth;
                    video.height = window.innerHeight - menuHeight;

                    videoCanvas.width = window.innerWidth - scrollBarWidth;
                    videoCanvas.height = window.innerHeight - menuHeight;

//                    canvas.width = $(document).width();// - scrollBarWidth;
//                    canvas.height = $(document).height();

//                    console.log("larg " + window.innerWidth + "haut " + window.innerHeight);
//                    videoCanvas.getContext('2d').drawImage(video, 0, 0, window.innerWidth - scrollBarWidth, window.innerHeight - menuHeight);
//                    videoCanvas.getContext('2d').drawImage(video, 0, 0, video.width, video.height);
//                    }
                }
                window.onresize = onResizeHandler;
//                window.onfullscreenchange = onResizeHandler;
//                window.onwebkitfullscreenchange = onResizeHandler;
//                window.onmozfullscreenchange = onResizeHandler;

                //////////////////////


                function getScrollerWidth() {
                    var scr = null;
                    var inn = null;
                    var wNoScroll = 0;
                    var wScroll = 0;

                    // Outer scrolling div
                    scr = document.createElement('div');
                    scr.style.position = 'absolute';
                    scr.style.top = '-1000px';
                    scr.style.left = '-1000px';
                    scr.style.width = '100px';
                    scr.style.height = '50px';
                    // Start with no scrollbar
                    scr.style.overflow = 'hidden';

                    // Inner content div
                    inn = document.createElement('div');
                    inn.style.width = '100%';
                    inn.style.height = '200px';

                    // Put the inner div in the scrolling div
                    scr.appendChild(inn);
                    // Append the scrolling div to the doc

                    document.body.appendChild(scr);

                    // Width of the inner div sans scrollbar
                    wNoScroll = inn.offsetWidth;
                    // Add the scrollbar
                    scr.style.overflow = 'auto';
                    // Width of the inner div width scrollbar
                    wScroll = inn.offsetWidth;

                    // Remove the scrolling div from the doc
                    document.body.removeChild(document.body.lastChild);

                    // Pixel width of the scroller
                    return (wNoScroll - wScroll);
                }

            });

            /*
             * Fonction pour afficher le panneau d'information du batiment que l'on a repéré
             */
            function showInfoPanel() {
                //On enregistre le marqueur
                currentPanelMarker = currentMarker;

                //Si le panel du bas est affiché
                if ($("#bottomPopUp").css('display') === 'block') {
                    //On ferme le popUp du bas
                    closeBottomPopUp();
                }

                //On cherche l'element actuellement detecte dans le tableau via un id
                elemDetected = elementsArray[currentPanelMarker];
                //Construction du panel d'info en fonction de l'element
                buildPanel(elemDetected);
                $("#informationPanel").css("display", "block");

                isPanelDisplayed = true;
            }

            /*
             * Ouverture du pop en fonction du batiment detecté
             * @returns {undefined}
             */
            function showPopUp(idElem) {
                var elem = elementsArray[idElem];
                var textTitle = elem.name;
                var textBody = elem.subElements[0].content;
                var textType = elem.type;
                $("#popUpTitle").html(textTitle);
                $("#popUpContent").html(textBody);
                $("#bottomPopUpDescription").html("<strong>" + textTitle + "</strong> - " + textType);

                //Si le panel centrale n'est pas affiché, popup centrale
                //Sinon popUp bottom
                if (!isPanelDisplayed) {
                    $("#popUpInfos").modal('show');
                } else {
                    showBottomPopUp();
                }

            }


            /*
             * Ferme le panel actuellement ouvert
             */
            function closePanel() {
                currentPanelMarker = null;
                $("#informationPanel").css("display", "none");
                isPanelDisplayed = false;
            }

            function switchAction() {
                showBottomPopUp();
            }

            /*
             * Afficher le popup du bas
             */
            function showBottomPopUp() {
                $("#bottomPopUp").animate({
                    height: "toggle"
                }, 600, "linear", function() {
                    console.log("show!!");
                });
            }

            /*
             * Fermer le popup du bas
             */
            function closeBottomPopUp() {
                $("#bottomPopUp").animate({
                    height: "toggle"
                }, 500, "linear", function() {
                    console.log("close!!");
                });
            }


            /*
             * Fonction pour charger le tableau des elements
             */
            function loadElements() {
                var elem0 = {
                    "name": "POLYTECH",
                    "type": "Université UJF",
                    "subElements": [
                        {"title": "Information", "content": "POLYTECH GRENOBLE est l'école d'ingénieurs de l'UNIVERSITE JOSEPH FOURIER.C\n\
        ’est une grande école habilitée par la Commission des Titres d’Ingénieur, labelisée IDEFI (Initiatives d'Excellence en Formations Innovantes). Comme toutes les autres écoles du RESEAU POLYTECH, elle s’appuie sur un fort partenariat avec le monde de l’entreprise"},
                        {"title": "Horaire", "content": "12h:55    22h45"},
                        {"title": "Casier", "content": "Lorem ipsum dolor sit amet, charetra varius quam sit amet vulputate. Quisque mauris augue, molestie tincidunt condimentum vitae, gravida a libero."}
                    ]
                };

                var elem4 = {
                    "name": "BU",
                    "type": "Université UJF",
                    "subElements": [
                        {"title": "Information", "content": "Lorem ipsum dolor sit amet, charetra varius quam sit amet vulputate. Quisque mauris augue, molestie tincidunt condimentum vitae, gravida a libero."},
                        {"title": "Horaire", "content": "12h:55    22h45"}
                    ]
                };
                elementsArray[0] = elem0;
                elementsArray[4] = elem4;
            }

            /*
             * Chargement d'un objet représentant l'element detecté
             * Information des différents labels du panel :
             *      .Titre
             *      .Onglets
             *          .Titre onglet
             *          .Contenu
             */
            function buildPanel(objElem) {

                /* Clean le panel */
                cleanChildOfNodeID("tabsPanel");
                cleanChildOfNodeID("contentTabs");

                //Titre du panel info
                $("#informationTitle").html(objElem.name);

                //Booleen pour avoir le premier element active
                var firstElementSelected = false;

                objElem.subElements.forEach(function(entry, index) {
//                    console.log("---");
//                    console.log("Titre " + entry.title);
//                    console.log(" Contenu " + entry.content);

                    //Creation d'un onglet
                    var tabTitle = "";
                    if (!firstElementSelected) {
                        //On met en active le premier
                        tabTitle = "<li class=\"active\"><a href=\"#tabbedPan" + index + "\" data-toggle=\"tab\">" + entry.title + "</a></li>";
                    } else {
                        tabTitle = "<li><a href=\"#tabbedPan" + index + "\" data-toggle=\"tab\">" + entry.title + "</a></li>";
                    }
                    $("#tabsPanel").append(tabTitle);

                    //Creation du contenu de l'onglet
                    var tabContent = "";
                    if (!firstElementSelected) {
                        //Active le premier
                        tabContent = "<div class=\"tab-pane active\" id=\"tabbedPan" + index + "\">" + entry.content + "</div>";
                        firstElementSelected = true;
                    } else {
                        tabContent = "<div class=\"tab-pane\" id=\"tabbedPan" + index + "\">" + entry.content + "</div>";
                    }
                    $("#contentTabs").append(tabContent);

                });

            }

            /*
             * Enleve les child d'un node
             */
            function cleanChildOfNodeID(parentNode) {
                var myNode = document.getElementById(parentNode);
                while (myNode.firstChild) {
                    myNode.removeChild(myNode.firstChild);
                }
            }

        </script>

    </head>
    <body>
        <div id="wrapper">
            <!--MENU-->
            <nav id="menu" class="navbar navbar-static-top navbar-inverse">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <ul class="nav">
                            <li><a href="#"><i class="icon-white icon-cog"></i> Paramètres</a></li>
                            <li><a href="#"><i class="icon-white icon-info-sign"></i> Aide</a></li>
                        </ul>
                        <button id="btnFullScreen" class="btn btn-primary pull-right" onclick="manageFullScreen(document.documentElement);">FullScreen</button>
                        <button class="btn btn-primary pull-right" onclick="switchAction()">Switch</button>
                    </div>
                </div>
            </nav>

            <!--DIV POUR LA VIDEO-->
            <div id="backgroundVideo"></div>

            <!--DIV QUI CONTIENDRA L'UI-->
            <div id="mainContent" class="container-fluid">
                <!-- Tout le contenu dans une row -->
                <div class="row-fluid voffset5">
                    <div id="pageContent" class="span12">

                        <div id="informationPanel">
                            <div class="titlePanel">
                                <h3 id="informationTitle"></h3>
                                <button class="btn btn-primary" onclick="closePanel()">x</button>
                            </div>
                            <div class="tabbable tabs-left">
                                <ul id="tabsPanel" class="nav nav-tabs">
                                </ul>
                                <div id="contentTabs" class="tab-content"></div>
                            </div>
                        </div>

                    </div>

                    <!-- POP UP AFFICHER QUAND EN FACE D'UN BATIMENT -->
                    <div id="popUpInfos" class="modal hide fade">
                        <div class="modal-header"> <a class="close" data-dismiss="modal">×</a>
                            <h3 id="popUpTitle"></h3>
                        </div>
                        <div id="popUpContent" class="modal-body">
                            Voulez-vous l'afficher ?
                        </div>
                        <div id="popUpFooter" class="modal-footer"> 
                            <a class="btn btn-success" onclick="showInfoPanel()" data-dismiss="modal">Plus d'informations ?</a>
                        </div>
                    </div>

                    <!-- Barre du bas pour le popUp info quand un panel est déjà affiché-->
                    <nav id="bottomPopUp" class="navbar navbar-fixed-bottom navbar-inverse">
                        <div class="navbar-inner">
                            <div class="container-fluid" >
                                <button class="btn btn-large btn-primary pull-right" onclick="closeBottomPopUp()">X</button>
                                <div id="bottomPopUpArrow" class="row-fluid" onclick="showInfoPanel()">^</div>
                                <div id="bottomPopUpContent" class="row-fluid" onclick="showInfoPanel()">
                                    <div id="bottomPopUpPicture" class="span2"></div>
                                    <div id="bottomPopUpDescription" class="span7"></div>
                                </div>
                            </div>
                        </div>
                    </nav>

                </div>
            </div>
        </div>

        <script>
            loadElements();
        </script>
    </body>
</html>
